(window.multistep_editor_jsonpFunction=window.multistep_editor_jsonpFunction||[]).push([[29],{403:function(e,t,s){"use strict";s.d(t,"a",function(){return i});class i{static throw(e,...t){throw`${e}: ${t.join(", ")}`}}i.InvalidProcessorExpression="Invalid expression",i.CannotFoundType="Cannot found type",i.CannotFoundTypeConstructor="Cannot found constructor of type",i.CannotFoundStaticMethod="Cannot found static method",i.CannotFoundEnum="Cannot found enumeration",i.InvalidEnumValue="Enum does not contain value",i.DublicateTypesFound="Dublicate types have been detected",i.CommandNotFound="Command not found"},473:function(e,t,s){"use strict";s.d(t,"a",function(){return n});var i=s(166),a=s(29);class n{static get iframeApiPromise(){return this._iframeApiSubject.pipe(Object(a.a)(1)).toPromise()}static loadCCScript(e,t){if("undefined"!=typeof CustomersCanvas||document.body.querySelector("#CcIframeApiScript"))"undefined"!=typeof CustomersCanvas&&this._iframeApiSubject.next(CustomersCanvas);else{this._iframeApiSubject=new i.a(1);let s=document.createElement("script");s.type="text/javascript",s.id="CcIframeApiScript",s.onload=(e=>{CustomersCanvas&&this._iframeApiSubject.next(CustomersCanvas)}),s.onerror=(e=>{this._iframeApiSubject.error(e)}),s.src=e+t,document.body.appendChild(s)}return this.iframeApiPromise}}n._iframeApiSubject=new i.a(1)},474:function(e,t,s){"use strict";s.d(t,"a",function(){return l});var i=s(475),a=s(38),n=s(714),o=s(6),r=s(551),c=s(25);class l{constructor(e,t,s=(()=>Promise.resolve())){this._lastJobKey="init",this._lastExecutedJobSubject=new i.BehaviorSubject("init"),this._commands=e,this._onJobFinish=s,this.logger=new c.Category("command-executer_"+t)}executeActions(e,t,s){const i=async n=>{this.logger.debug(()=>`Execute '${n}'`);let o=Promise.resolve();const r=this._commands[n];if(r&&void 0!==r.execute){o=r.execute(e[n],s[n]);let c=e[n].after;if(!c&&Array.isArray(e[n])){const t=e[n].find(e=>e.after);t&&(c=t.after)}if(void 0!==c){Object(a.a)(c)||(c=[c]);const e=(e,t,s)=>{const i=s.indexOf(e);return s.indexOf(t)>i};for(let s=0;s<c.length;s++){const a=c[s];e(n,a,t)||(await o,o=i(a))}}}else console.warn(`Action ${n} is not supported! Double check the config.`);return o},n=this.getJobReady(this._lastJobKey),r=this._lastJobKey=o.a.guid();return n.then(()=>(this.logger.debug(()=>`Start actons: ${t}`),o.a.recursiveJobPromise(t,i))).then(()=>this._onJobFinish()).finally(()=>{this.logger.debug(()=>`End actons: ${t}`),this._lastExecutedJobSubject.next(r)})}getJobReady(e){return this._lastExecutedJobSubject.pipe(Object(r.filter)(t=>t===e),Object(r.take)(1)).toPromise()}getChangedActions(e,t){const s=Object.keys(e).filter(t=>o.a.isObjectNotEmpty(e[t])).filter(s=>void 0===t[s]||!((e,t)=>JSON.stringify(e)===JSON.stringify(t))(e[s],t[s])),i=s.indexOf("actionsErrorToast");return-1!==i&&s.splice(i,1),s.indexOf("initial")>-1?["initial"].concat(Object(n.a)(s,"initial")):s}}},542:function(e,t,s){"use strict";var i=s(21),a=s(22),n=s(403),o=s(27),r=s(404),c=s(368),l=s(375),d=s(389),u=s(380),h=s(372);class g{constructor(){this._types=new Map;const e=[r,c,l,d];for(let t=0;t<e.length;t++)this._loadModuleTypes(e[t]);this._loadModuleTypes({Collection:u.a})}fromConstructor(e,...t){Object(h.e)(e)&&n.a.throw("Invalid argument",e);const s=this._findFunction(e);this._isConstructor(s)||n.a.throw(n.a.CannotFoundTypeConstructor,e);const i=s;try{return new i(...t)}catch(e){throw console.error(e),e}}_findFunction(e){const t=e.split(".");this._types.has(t[0])||n.a.throw(n.a.CannotFoundType,e);let s=this._types.get(t[0]);for(let i=1;i<t.length;i++)void 0==s[t[i]]&&n.a.throw(n.a.CannotFoundTypeConstructor,e),s=s[t[i]];return s}_isConstructor(e){return e instanceof Function&&null!=e.prototype.constructor}fromStaticMethod(e,...t){const s=this._findFunction(e);null!=s&&s instanceof Function||n.a.throw(n.a.CannotFoundStaticMethod,e);try{return s(...t)}catch(e){throw console.error(e),e}}fromProperties(e,t){const s=this.fromConstructor(e);return Object(h.a)(s,[t],{deep:!1,ignoreNull:!1})}fromEnum(e,t){this._types.has(e)||n.a.throw(n.a.CannotFoundEnum,e);const s=this._types.get(e);return s instanceof Object||n.a.throw(n.a.CannotFoundEnum,e),null==s[t]&&n.a.throw(n.a.InvalidEnumValue,{type:e,value:t}),s[t]}_loadModuleTypes(e){if(void 0!==e)for(let[t,s]of Object.entries(e))(s instanceof Function||s instanceof Object)&&(this._types.has(t)&&n.a.throw(n.a.DublicateTypesFound,t),this._types.set(t,s))}}s.d(t,"a",function(){return m});class m extends a.a{subProcessorAllocatorFactory(){const e=new o.a;return e.register(new p(this,new g)),e}}class p extends i.a{constructor(e,t){super(e),this._builder=t}apply(e,t,s=(e=>e)){switch(!0){case Array.isArray(e):return e.map(e=>s(e));case this.isObject(e):const t={};for(let[i,a]of Object.entries(e)){if(this._isNewExpression(i)||this._isCallExpression(i))return this._buildObjectModel(i,a,s);t[i]=this._buildModelProperty(a,s)}return t;case this._isEnumExpression(e):return this._parseEnum(e);default:return e}}_buildModelProperty(e,t){switch(!0){case this.isObject(e):return t(e);case this._isEnumExpression(e):return this._parseEnum(e);default:return e}}_parseArguments(e,t){switch(!0){case Array.isArray(e):return e.map(e=>this._parseArguments(e,t));case this.isObject(e)&&this.canApply(e):return t(e);case this._isEnumExpression(e):return this._parseEnum(e);default:return e}}_parseEnum(e){const t=this.splitOperandAndCondition(e);1===t.length&&null!=t[0].body||n.a.throw(n.a.InvalidProcessorExpression,e);const s=t[0].body.split(".");return 2==s.length?this._builder.fromEnum(s[0],s[1]):null}_buildObjectModel(e,t,s){const i=this.splitOperandAndCondition(e);1==i.length&&null!=i[0].body||n.a.throw(n.a.InvalidProcessorExpression,e);const a=i[0].body;return this._isCallExpression(e)?this._buildObjectByFactory(a,t,s):this._createObjectModel(a,t,s)}_buildObjectByFactory(e,t,s){let i=t;return Array.isArray(t)?i=t.map(e=>this._parseArguments(e,s)):this.isObject(t)&&(i=s(t)),this._builder.fromStaticMethod(e,i)}_createObjectModel(e,t,s){switch(!0){case this.isObject(t):return this._builder.fromProperties(e,s(t));case Array.isArray(t):const i=t.map(e=>this._parseArguments(e,s));return this._builder.fromConstructor(e,...i);default:return this._builder.fromConstructor(e,t)}}canApply(e){return this.isObject(e)&&void 0!==Object.entries(e).find(([e,t])=>this._isNewExpression(e)||this._isCallExpression(e)||this._isEnumExpression(t))}_isNewExpression(e){return/{{.*(#new).*/gi.test(e)}_isCallExpression(e){return/{{.*(#call).*/gi.test(e)}_isEnumExpression(e){return this.isString(e)&&/{{.*(#enum).*/gi.test(e)}}},866:function(e,t){e.exports="<style>\r\n    :host {\r\n        width: 100%;\r\n        height: 100%;\r\n        display: block;\r\n        position: relative;\r\n    }\r\n\r\n    #design-editor {\r\n        position: absolute;\r\n        height: 1px;\r\n        min-height: 100%;\r\n        width: 1px;\r\n        min-width: 100%;\r\n        top: 0;\r\n        bottom: 0;\r\n        left: 0;\r\n        right: 0;\r\n        border: none;\r\n        background-color: transparent;\r\n    }\r\n</style>\r\n<iframe id='design-editor' allowfullscreen></iframe>"},919:function(e,t,s){"use strict";s.r(t);var i=s(0),a=s(866),n=s(117),o=s(167),r=s(29);class c{constructor(e){Object.assign(this,e)}}var l=s(394),d=s(454),u=s(455),h=s(456),g=s(457),m=s(458),p=s(432),f=s(462),w=s(413),y=s(396),b=s(471),P=s(6);class C{constructor(e){this.widget=e}}var v=s(52);var I=s(441);var _=s(389);var x=s(372),O=s(542);var A=s(435);var E=s(473),S=s(1),M=s(20),j=s(474);class R{constructor(){this.promise=new Promise(function(e,t){this._resolve=e,this._reject=t}.bind(this))}then(e){return this.promise.then(e)}catch(e){return this.promise.catch(e)}resolve(e=""){this._resolve(e)}reject(e){this._reject(e)}}var T=s(194),F=s(540);s.d(t,"AuWidgetDesignEditor",function(){return z}),s.d(t,"widget",function(){return z});let z=class extends class extends n.c{constructor(){super(...arguments),this._customersCanvasSubject=new o.ReplaySubject(1)}customersCanvasPublish(e){this._customersCanvasSubject.next(e)}get customersCanvasObservable(){return this._customersCanvasSubject.asObservable()}get customersCanvasPromise(){return this.customersCanvasObservable.pipe(Object(r.a)(1)).toPromise()}async getProduct(){const e=await this.getEditor();return await e.getProduct()}async getEditor(){return await this._customersCanvasSubject.asObservable().pipe(Object(r.a)(1)).toPromise()}async getDesignEditorItemModel(e){const t=e.type===m.b.type,s=e.type===l.a.type||e.type===u.a.type||e.type===h.a.type||e.type===g.a.type||e.type===d.a.type;e.type,p.a.type;let i=!1,a=!1;if(!e)return;let n={name:e.name};switch(t&&(e=e,i=P.a.isNotNullOrUndefined(e.content)&&(e.content instanceof p.a||"ImageItem"===e.content.type),a=P.a.isNotNullOrUndefined(e.content)&&(e.content instanceof f.b||"BarcodeItem"===e.content.type)),s&&(e=e),!0){case t&&i&&!a&&null!==e.content.tags.sourceData&&void 0!==e.content.tags.sourceData:{const t=(e=e).content,s=new y.a(e).getTransformedRectangle(),i=new w.a(t).getTransformedRectangle(),a=await this.getEditor();let o=300;try{o=await a.eval("var printArea = spEditor.productHandler.product.surfaces.elementAt(0).printAreas.elementAt(0);var config = spEditor.configuration.renderingConfig.getHiResRendering(printArea);config.dpi;")}catch(e){console.warn("Failed to get hires render config dpi")}n.tags=Object(b.a)(t.tags),n.value=t.tags.sourceData.name,n.placeholderContent={originalUrl:t.tags.sourceData.originalUrl,width:t.source.width,height:t.source.height,placeholderRectangle:s,contentRectangle:i,contentResizeMode:m.c[e.contentResizeMode].toLowerCase(),contentTransform:{angle:t.transform.angle,scaleX:t.transform.scaleX,scaleY:t.transform.scaleY,translateX:t.transform.translateX,translateY:t.transform.translateY},dpi:o};break}case t&&i:n={name:e.name,tags:Object(b.a)(e.tags)};break;case s&&!!e.text:{const t=e;let s="",i=e=>(e/255).toFixed(7);if(t.color)if("RgbColor"===t.color.type){const e=t.color;s=`rgb(${e.r},${e.g},${e.b},${i(e.a)})`}else if("CmykColor"===t.color.type){const e=t.color;s=`cmyk(${i(e.c)},${i(e.m)},${i(e.y)},${i(e.k)},${i(e.a)})`}n={name:e.name,value:t.text,color:s,font:{postScriptName:t.font.postScriptName,size:t.font.size,fauxBold:t.font.fauxBold,fauxItalic:t.font.fauxItalic}};break}}return t&&((e=e).contentPermissions&&e.contentPermissions.imagePermissions&&(n.contentPermissions={imagePermissions:{allowChangeImage:e.contentPermissions.imagePermissions.allowChangeImage,allowEditImage:e.contentPermissions.imagePermissions.allowEditImage}}),e.placeholderPermissions&&(n.placeholderPermissions={allowEditContent:e.placeholderPermissions.allowEditContent,showHandleButton:e.placeholderPermissions.showHandleButton,showSelectButton:e.placeholderPermissions.showSelectButton})),e.visualizationPermissions&&(n.visualizationPermissions={noPrint:e.visualizationPermissions.noPrint,noShow:e.visualizationPermissions.noShow}),null!==e.locked&&(n.locked=e.locked),new c(n)}}{constructor(){super(...arguments),this._isRestoring=!1,this.CC_SCRIPT_RELATIVE_PATH="/Resources/Generated/IframeApi.js",this.modifiedItem=null,this._currentSurfaceName="",this.overallBounds={},this._hiResUrls=[],this._proofImageUrls=[[]],this._stateId="",this._userId="",this._userChanges={},this._variableData=[],this._allItems=[],this._depositPhotos=[],this._tags={},this._lastParams={},this._currentParams={},this.actionsFinished=!1,this.actionsFinishedPromise=new R,this.commands={initial:new class extends C{async execute(e){return await this.widget.iframeApiPromise,await this.load(e.productDefinition,e.editorConfig,e.maximizeAssetManager||e.galleryObserverEnable),"string"==typeof e.productDefinition&&(this.widget._stateId=e.productDefinition,this.widget._userId=this.widget.driver.user.id),v.Maybe.maybe(e).map(e=>e.viewerSettings).caseOf({just:e=>this.widget.applyViewerSettings(e),nothing:()=>this.widget.customersCanvasPromise})}async load(e,t,s){const i=this;e.surfaces&&Array.isArray(e.surfaces)&&e.surfaces.forEach(function(e){"object"==typeof e&&void 0!==e.width&&void 0!==e.height&&(e.width=Number(e.width),e.height=Number(e.height))}),i.widget.modifiedItem&&i.widget.updateModifiedItem({});const a=this.widget.shadowRoot.querySelector("#design-editor"),n=await CustomersCanvas.IframeApi.loadEditor(a,e,t);let o;this.listenBoundsChanges(n);try{o=await n.getProduct(),o=await o.switchTo(o.surfaces[0])}catch(e){return console.error("Load failed with exception: ",e),void i.widget.dispatchEvent(new CustomEvent("error",e))}i.listenItemChanges(n),i.listenSurfaceChanges(n),i.widget.customersCanvasPublish(n),i.widget.dispatchEvent(new CustomEvent("ready",{detail:{product:o,customersCanvas:n}})),await this.widget.replaceInterpolationPlaceholder(),s&&(i.listenModalClose(n),i.listenModalOpen(n),i.listenAssetManagerClose(n),i.listenAssetManagerOpen(n)),i.listenOriginalSize(n),i.listenFullWindow(n)}async listenItemChanges(e){e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.ItemChanged,async e=>{if(P.a.isNullOrUndefined(e))return;const t=await this.widget.getDesignEditorItemModel(e);this.widget.updateModifiedItem(t)})}listenBoundsChanges(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.BoundsNotification,function(e){t.widget.updateOverallBounds(e.overallBounds)})}listenSurfaceChanges(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.OnSurfaceChanged,function(e){t.widget.updateCurrentSurfaceName()})}listenOriginalSize(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.OriginalSize,()=>{t.widget.toggleMaximizeMainPanel(!1)})}listenFullWindow(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.FullWindow,()=>{t.widget.toggleMaximizeMainPanel(!0)})}listenModalClose(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.ModalClose,()=>{t.widget.toggleMaximizeMainPanel(!1)})}listenModalOpen(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.ModalOpen,()=>{t.widget.toggleMaximizeMainPanel(!0)})}listenAssetManagerClose(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.AssetManagerClosed,()=>{t.widget.toggleMaximizeMainPanel(!1)})}listenAssetManagerOpen(e){const t=this;e.subscribe(CustomersCanvas.IframeApi.PostMessage.Events.AssetManagerOpened,()=>{t.widget.toggleMaximizeMainPanel(!0)})}}(this),changeMockup:new class extends C{async execute(e){const t=await this.widget.getProduct(),s=e.data.map((e,s)=>({mockup:e.mockup,previewMockups:e.previewMockups,surface:t.surfaces[s]}));return await t.setMockups(s,e.options)}}(this),setPrintArea:new class extends C{async execute(e){let t=await this.widget.getProduct();Array.isArray(e)||(e=[e]);for(let s=0;s<e.length;s++){const i=e[s];if(!i.data)continue;let a=t.currentSurface;"number"==typeof i.surfaceIndex&&(a=t.surfaces[i.surfaceIndex]),t=await a.setPrintAreas([i.data],i.options),await this.widget.replaceInterpolationPlaceholder()}}}(this),setTheme:new class extends C{async execute(e){"string"==typeof e?e={theme:e}:void 0===e.theme&&(e={theme:e});const t=await this.widget.getProduct();return await t.applyProductTheme(e.theme)}}(this),setBackground:new class extends C{async execute(e){const t=await this.widget.getEditor(),s=await t.getProduct(),i=await s.getProductModel();let a=e.surfaceIndex;(void 0===a||null===a||a<0||a>i.surfaces.length)&&(a=0);const n=i.surfaces.get(a),o=n.printAreas.get(0),r=n.containers.first(e=>e.name===I.a.BG_CONTAINER_NAME),c=r.items.get(0),l=c.content;if(e.url.startsWith("public:")||e.url.startsWith("user:")){const o=await t.configuration.getImageMetadata(e.url);if((e.url.endsWith(".pdf")||e.url.endsWith(".svg"))&&(o.isVector=!0),!0===e.toTile){const e=c.content||c;e.sourceRectangle.width=o.size.width,e.sourceRectangle.height=o.size.height,e.setData(o),e.source.isVector=o.isVector,r.items.setRange(this._getTiles(e,n)),await s.setProductModel(i)}else if(s.surfaces.length>a){const e=s.surfaces[a];await e.changeBackground(o)}}else await l.loadImageFromRemoteUrl(CustomersCanvas.IframeApi.editorUrl,e.url),l.source.isVector=this._isVector(e.url),e.autoResize&&(n.width=l.sourceRectangle.width,n.height=l.sourceRectangle.height,o.bounds.width=n.width,o.bounds.height=n.height),!0===e.toTile&&r.items.setRange(this._getTiles(l,n)),await s.setProductModel(i);await this.widget.ready()}_getTiles(e,t){let s=[],i=0,a=0;for(;a<t.height;){for(;i<t.width;){let t=e.clone();t.values=[],t.transform.setTranslateX(i),t.transform.setTranslateY(a),t.locked=!0,s.push(t),i+=e.source.width}i=0,a+=e.source.height}return s}_isVector(e){return e.endsWith(".pdf")||e.endsWith(".svg")}}(this),updateContainerSettings:new class extends C{async execute(e){if(null==e||!(e instanceof Array))return;const t=await this.widget.getProduct();for(let s of e){let i=e.indexOf(s);const a=t.surfaces[i];if(null!=a)for(let[e,t]of Object.entries(s)){const s=a.printAreas[0].getContainer(e);null!=s?await s.update(t):console.warn(`Container with name ${e} was not found!`)}}}}(this),setRemoteMockup:new class extends C{async execute(e){if(null==e)return Promise.resolve();const t=await this.widget.getEditor(),s=await t.getProduct(),i=await s.getProductModel();for(let a of e){if(P.a.isNullOrUndefined(a.url)||""===a.url)continue;const e="number"==typeof a.surfaceIndex?i.surfaces.get(a.surfaceIndex):i.surfaces.first(e=>e.name===s.currentSurface.name),n="up"===a.mockup.toLowerCase()?e.mockup.overContainers:e.mockup.underContainers;if(n.empty||n.get(0).items.empty){console.warn("Cannot set mockup because MockupContainer is empty");continue}const o=n.get(0).items.get(0),r=await t.configuration.getImageMetadata(a.url);r.size={width:r.size.width||r.width,height:r.size.height||r.height},r.name=o.name,o.setData(r)}await s.setProductModel(i)}}(this),modifyItems:new class extends C{async execute(e,t){if(P.a.isEmptyObject(e)||P.a.isEmptyObject(e.every)&&P.a.isEmptyObject(e.items))return Promise.resolve();e.items=e.items||{},P.a.isNotNullOrUndefined(t)&&(e=this._removeOldParams(e,t));const s=await this.widget.getEditor(),i=await s.getProduct();await this._modifyItems(e,i,s),await this._applyUserInfo(s,e)}async _modifyItems(e,t,s){const i=await t.getProductModel();if(P.a.isNullOrUndefined(e))return;P.a.isNotNullOrUndefined(e.items)&&await this._applyBackgroundColor(e,t);const a=i.getAllItems();for(const t of a){const i=Object.assign({},e.every,e.items[t.name]);0!==Object.keys(i).length&&this.needApplyOnce(i,t)&&(this._isTextItem(t.type)?this._updateTextItem(i,t):t.type===_.PlaceholderItem.type?await this._updatePlaceholderItem(i,t,s):t.type===_.ShapeItem.type&&await this._updateShapeItem(i,t),this._updateVisualizationPermissions(i,t),this.setApplyOnce(i,t))}const n=t.currentSurfaceIndex>0?t.currentSurfaceIndex:0;await t.setProductModel(i),t=await s.getProduct(),await t.switchTo(t.surfaces[n])}needApplyOnce(e,t){return!(!0===e.once&&t&&t.tags.modifyItems&&!0===t.tags.modifyItems.once)}setApplyOnce(e,t){!0===e.once&&t&&(t.tags.modifyItems=t.tags.modifyItems||{},t.tags.modifyItems.once=!0)}_isTextItem(e){return e===_.BaseTextItem.type||e===_.BoundedTextItem.type||e===_.PlainTextItem.type||e===_.CurvedTextItem.type||e===_.AutoScaledTextItem.type}_removeOldParams(e,t){for(const s in e.items){const i=t.items[s],a=e.items[s];JSON.stringify(i)===JSON.stringify(a)&&!0!==a.force&&delete e.items[s]}return e}async _applyBackgroundColor(e,t){const s=e.items.background;if(null!=s&&null!=s.color){const e=window.CustomersCanvas.DesignAtoms.ObjectModel.ColorFactory.createColor(s.color);for(const s of t.surfaces)await s.changeBackground(e)}}_updateTextItem(e,t){const s=e.text||e.value;if(null!=s&&(t.text=s),t.placeholders&&t.placeholders.length>0&&(t.placeholders.forEach(e=>e.value=s),t.value=s),null!=e.font){let s=e.font.bold||e.font.fauxBold;s&&(t.font.fauxBold=s);let i=e.font.italic||e.font.fauxItalic;i&&(t.font.fauxItalic=i);let a=e.font.family||e.font.postScriptName;a&&(t.font.postScriptName=a),e.font.size&&(t.font.size=e.font.size),e.font.underline&&(t.underline=e.font.underline);let n=e.color||e.font.color;n&&(t.color=window.CustomersCanvas.DesignAtoms.ObjectModel.ColorFactory.createColor(n))}if(!0===e.locked&&(t.textPermissions.allowChangeText=!1,t.textPermissions.allowChangeTextBIU=!1),t.type===_.PlainTextItem.type){let s=e.position||e.location;if(s){let e=0,i=0;const a=t;t.alignment=_.TextAlignment.Left,s||(s={x:0,y:0}),e=s.x||a.baselineLocation.x,i=s.y||a.baselineLocation.y,a.baselineLocation=new window.CustomersCanvas.DesignAtoms.ObjectModel.PointF(e,i)}}if(t.type===_.BoundedTextItem.type||t.type===_.AutoScaledTextItem.type){const s=t;let i=e.position||e.location;if(i||e.size){let t=0,a=0,n=0,o=0;i||(i={x:0,y:0}),t=i.x||s.textRectangle.left,a=i.y||s.textRectangle.top,e.size||(e.size={width:0,height:0}),n=e.size.width||s.textRectangle.width,o=e.size.height||s.textRectangle.height,s.textRectangle.width=n,s.textRectangle.height=o,s.textRectangle.left=t,s.textRectangle.top=a}}}_updateVisualizationPermissions(e,t){e.visualizationPermissions&&(P.a.isNotNullOrUndefined(e.visualizationPermissions.noPrint)&&(t.visualizationPermissions.noPrint=e.visualizationPermissions.noPrint),P.a.isNotNullOrUndefined(e.visualizationPermissions.noShow)&&(t.visualizationPermissions.noShow=e.visualizationPermissions.noShow)),P.a.isNotNullOrUndefined(e.locked)&&(t.locked=e.locked)}async _updatePlaceholderItem(e,t,s){if("ImagePlaceholder"===e.type){if((e=>e.placeholderContent&&e.tags&&e.tags.sourceData&&e.value===e.tags.sourceData.name)(e)){if(-1===e.placeholderContent.originalUrl.indexOf("?x-cctoken=")){const t=await this.widget.getToken();""!==t&&(e.placeholderContent.originalUrl+=`?x-cctoken=${t}`)}let i=e.placeholderContent.originalUrl;e.tags.sourceData.originalUrl=i;const a=await s.configuration.getImageMetadata(i),n=t.content;t.isStubContent=!1,n.setData(a),n.tags=e.tags,n.parentPlaceholder=t;const o=new y.a(t),r=new w.a(n);r.updateRectangle(!1,t.contentResizeMode,o);const c=o.getTransformedRectangle(),l=e.placeholderContent;if(c.angle!==l.placeholderRectangle.angle||c.width!==l.placeholderRectangle.width||c.height!==l.placeholderRectangle.height||c.centerX!==l.placeholderRectangle.centerX||c.centerY!==l.placeholderRectangle.centerY){const e=new window.CustomersCanvas.DesignAtoms.ObjectModel.RotatedRectangleF(l.placeholderRectangle.centerX,l.placeholderRectangle.centerY,l.placeholderRectangle.width,l.placeholderRectangle.height,l.placeholderRectangle.angle);o.setTransformedRectangle(e)}const d=r.getTransformedRectangle();if(d.angle!==l.contentRectangle.angle||d.width!==l.contentRectangle.width||d.height!==l.contentRectangle.height||d.centerX!==l.contentRectangle.centerX||d.centerY!==l.contentRectangle.centerY){const e=new window.CustomersCanvas.DesignAtoms.ObjectModel.RotatedRectangleF(l.contentRectangle.centerX,l.contentRectangle.centerY,l.contentRectangle.width,l.contentRectangle.height,l.contentRectangle.angle);r.setTransformedRectangle(e)}}else if(!t.isStubContent){const e=t.content;e.parentPlaceholder=t,e.setData(t.stubStorageMeta);const s=new y.a(t),i=new w.a(e);i.parentPlaceholder=s,i.updateRectangle(!1,t.contentResizeMode,s),t.isStubContent=!0}e.contentPermissions&&e.contentPermissions.imagePermissions&&(t.contentPermissions.imagePermissions.allowChangeImage=e.contentPermissions.imagePermissions.allowChangeImage,t.contentPermissions.imagePermissions.allowEditImage=e.contentPermissions.imagePermissions.allowEditImage),e.placeholderPermissions&&(t.placeholderPermissions.allowEditContent=e.placeholderPermissions.allowEditContent,t.placeholderPermissions.showHandleButton=e.placeholderPermissions.showHandleButton,t.placeholderPermissions.showSelectButton=e.placeholderPermissions.showSelectButton)}"BarcodePlaceholder"!==e.type||e.value||t.isStubContent||(t.content.applyBarcodeData(new window.CustomersCanvas.DesignAtoms.ObjectModel.BarcodeData("")),t.isStubContent=!0)}async _updateShapeItem(e,t){let s=e.color||e.fillColor;s&&(t.fillColor=window.CustomersCanvas.DesignAtoms.ObjectModel.ColorFactory.createColor(s));let i=e.position||e.location;if(i||e.size){let s=0,a=0,n=0,o=0;i||(i={x:0,y:0}),s=i.x||t.sourceRectangle.left,a=i.y||t.sourceRectangle.top,e.size||(e.size={width:0,height:0}),n=e.size.width||t.sourceRectangle.width,o=e.size.height||t.sourceRectangle.height,t.sourcePath=window.CustomersCanvas.DesignAtoms.ObjectModel.Path.rectangle(s,a,n,o)}}async _applyUserInfo(e,t){const s=e=>!!e.placeholderContent&&e.tags&&e.tags.sourceData&&e.value===e.tags.sourceData.name,i=await e.getProduct(),a=(await i.getProductModel()).getAllItems(),n={};for(const e of Object.keys(t.items)){const i=t.items[e],o=a.find(t=>t.name===e);this.needApplyOnce(i,o)&&(i.value||"Text"===i.type||"InString"===i.type||i.image)&&("ImagePlaceholder"===i.type&&s(i)||("BarcodePlaceholder"===i.type?i.barcodeSubType&&"None"!==i.barcodeSubType?"Url"===i.barcodeSubType?n[e]={BarcodeFormat:i.barcodeFormat,BarcodeSubType:i.barcodeSubType,Url:i.value}:"Phone"===i.barcodeSubType&&(n[e]={barcodeFormat:i.barcodeFormat,barcodeSubType:i.barcodeSubType,phone:i.value}):n[e]={barcodeFormat:i.barcodeFormat,barcodeValue:i.value}:n[e]=P.a.isNotNullOrUndefined(i.value)?i.value:i.image,this.setApplyOnce(i,o)))}if(P.a.isEmptyObject(n))return Promise.resolve();try{await e.loadUserInfo(n)}catch(e){this.widget.showToast("Error: Invalid data"),console.log(e)}}}(this),setViewerSettings:new class extends C{async execute(e){if(e){const t=await this.widget.getEditor(),s=Object.assign({},e);null!=e.scrollPosition&&(s.scrollingPosition={x:e.scrollPosition.X||e.scrollPosition.x,y:e.scrollPosition.Y||e.scrollPosition.y}),await t.setViewerSettings(s)}}}(this),updateItems:new class extends C{constructor(){super(...arguments),this._configProcessor=new O.a}async execute(e){const t=this._configProcessor.process(e,{}),s=await this.widget.getProduct(),i=await s.getProductModel(),a=await i.getAllItems();for(let e of a){const s=t.items[e.name];P.a.isNotNullOrUndefined(s)||Object(x.b)(e,s)}await s.setProductModel(i)}}(this),setSerializedProduct:new class extends C{constructor(){super(...arguments),this._serializer=new A.a}async execute(e){if(Object(x.e)(e.serializedProduct))throw"serializedProduct cannot be null or empty";const t=this._serializer.deserialize(e.serializedProduct),s=await this.widget.getProduct();await s.setProductModel(t)}}(this),setSurfaces:new class extends C{async execute(e){if(!e||!e.surfaces||0===e.surfaces.length)return;if(e.surfaces.some(e=>0===Object.keys(e).length))return;const t=await this.widget.getEditor();let s=await t.getProduct();await s.setSurfaces(e.surfaces),await this.widget.replaceInterpolationPlaceholder()}}(this)},this.itemsData={},this._token=""}get currentSurfaceName(){return this._currentSurfaceName}get proofImageUrls(){return this._proofImageUrls}get hiResUrls(){return this._hiResUrls}get stateId(){return this._stateId}get userChanges(){return this._userChanges}get userId(){return this._userId}get allItems(){return this._allItems}get variableData(){return this._variableData}get depositPhotos(){return this._depositPhotos}get tags(){return this._tags}updateParams(e){if(void 0!==e.initial&&(e.initial.editorConfig||(e.initial.editorConfig={}),e.initial.editorConfig.defaultLanguage=this.driver.config.language||"en",this.driver)){this._initialOrder=this._initialOrder||Object(b.a)(this.driver.orders[0]);const t=this.driver.user.id;t&&(e.initial.editorConfig.userId=t);const s=this.driver.user.tokenId;s&&(e.initial.editorConfig.tokenId=s);const i=this.auWizard.scopeInternal.widgetsData,a=i&&i[this.name]?i[this.name].stateId:this._initialOrder.data.stateId;a&&""!==a&&(e.initial.productDefinition=a),e.initial.editorConfig.preloader={enabled:!1}}}async exportWidgetData(e){return!0===e&&await this.saveProduct(),{stateId:this._stateId}}async restoreWidgetFromData(e,t=!1){if(!0===t){const t=Object.assign({},this.params.initial);t.productDefinition=e.stateId,await this.commands.initial.execute(t)}}async updateParamsAsync(e){await super.updateParamsAsync(e);let t=this._commandExecuter.getChangedActions(e,this._currentParams);if(0===t.length)return!1;if(-1!==t.indexOf("initial")){const s=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;let i=P.a.isNotNullOrUndefined(this._stateId)&&""!==this._stateId,a=P.a.isNotNullOrUndefined(e.initial.productDefinition)&&e.initial.productDefinition.toString().match(s);(i||a)&&(t=["initial"])}this.actionsFinishedPromise=new R,this.actionsFinished=!1,this.emitChange();const s=t.every(t=>{let s=e[t];return Array.isArray(e[t])&&(s=e[t][0]),!1===s.showPreloader});s||this.showPreloader(!0),this._currentParams=Object(b.a)(e);try{await this._commandExecuter.executeActions(e,t,this._lastParams)}catch(e){if(this.params.actionsErrorToast&&!0===this.params.actionsErrorToast.show){const e="widgets.canvas.actions.error";let t=this.localize(e);t===e&&(t="Something went wrong. Send the website support team information about your browser and steps to reproduce the problem."),this.showToast(t,this.params.actionsErrorToast.duration)}this.logger.error(()=>"Failed to perform an action on Design Editor. ",e)}finally{s||this.showPreloader(!1),this._lastParams=e,this.actionsFinishedPromise.resolve(),this.actionsFinished=!0,this.emitChange()}}connectedCallback(){super.connectedCallback(),this._commandExecuter=new j.a(this.commands,this.uniqWidgetName),this.baseUrl=this.driver.settings.customersCanvasBaseUrl,this.showPreloader(!0),this.iframeApiPromise=E.a.loadCCScript(this.baseUrl,this.CC_SCRIPT_RELATIVE_PATH),this.iframeApiPromise.then(()=>{this.showPreloader(!1),CustomersCanvas.IframeApi.editorUrl=this.baseUrl})}async switchSurfaceTo(e){const t=await this.getProduct();return(e<0||e>t.surfaces.length-1)&&this.logger.error(`Invalid surface index: ${e}`,Error),await t.switchTo(t.surfaces[e])}updateModifiedItem(e){Object(F.a)(this.modifiedItem,e)||(this.modifiedItem=e,this.emitChange({modifiedItem:this.modifiedItem},!1))}updateOverallBounds(e){Object(F.a)(this.overallBounds,e)||(this.overallBounds=e,this.emitChange({overallBounds:this.overallBounds},!1))}async updateCurrentSurfaceName(){const e=await this.getProduct();this._currentSurfaceName=e.currentSurface.name,this.emitChange()}async applyViewerSettings(e){return this.commands.setViewerSettings.execute(e)}async getProofImages(e=800,t=800,s=!1,i=!1,a=!1,n=1e3,o=1e3){const r=await this.getEditor();let c={};c="object"==typeof e?e:{maxWidth:e,maxHeight:t,pregeneratePreviewImages:s,generateProductProof:i,generateLargePreviews:a,largePreviewMaxWidth:n,largePreviewMaxHeight:o};const l=await r.getProofImages(c);return this._proofImageUrls=l.proofImageUrls,this.emitChange({urls:this.proofImageUrls},!0),l.proofImageUrls.map(e=>e[0])}async getHiResImages(e=800,t=800,s,i=!1,a){const n=await this.getEditor();null!==s&&""!==s||(s=void 0);const o=await n.finishProductDesign({stateId:s,proofMaxWidth:e,proofMaxHeight:t,pregeneratePreviewImages:i,fileName:a});return this._hiResUrls=o.hiResOutputUrls,this._proofImageUrls=o.proofImageUrls,this._stateId=o.stateId,this._userId=o.userId,this._userChanges=o.userChanges,this.emitChange({urls:this.hiResUrls,proofs:this.proofImageUrls,stateId:this.stateId,userId:this.userId,userChanges:this.userChanges},!0),o.hiResOutputUrls}async getVariableData(){const e=await this.getProduct();return this._variableData=(await e.getVariableItems()).reverse(),this.emitChange({data:this.variableData}),this.variableData}async getAllItems(){const e=await this.getProduct(),t=await e.getProductModel();return this._allItems=t.getAllItems().reverse(),this.emitChange(),this.allItems}async getDepositPhotos(){const e=await this.getProduct(),t=[];return(await e.getAllItems()).forEach(e=>{const s=e.tags.dp_data;Object(T.a)(s)||t.push({imageId:e.id,depositPhotosId:JSON.parse(s).id})}),this._depositPhotos=t,this.emitChange({data:this.depositPhotos}),t}async getTags(){const e=await this.getProduct();return this._tags=await e.getTags(),void 0===this._tags&&(this._tags={}),this.emitChange({tags:this.tags}),this.tags}async setTags(e){const t=await this.getProduct();await t.setTags(e),this._tags=e,this.emitChange({tags:this.tags})}async saveProduct(e){const t=await this.getEditor(),s=await t.saveProduct(e);return this._stateId=s.stateId,this._userId=s.userId,this.emitChange({stateId:this.stateId,userId:this.userId},!0),s}async replaceInterpolationPlaceholder(){if(!this._currentParams.replaceInterpolationPlaceholders)return Promise.resolve();(await this.getEditor()).replaceInterpolationPlaceholders()}toggleMaximizeMainPanel(e){this.publishData({main:e},M.a.TOGGLE_SIZE_MAIN)}async openAssetManagerFor(e){const t=await this.getEditor();await t.openGalleryForItem(e)}async getItemText(e){const t=await this.getEditor(),s=await t.getProduct(),i=(await s.getProductModel()).getAllItems().find(t=>t.name===e),a=i&&i instanceof _.BaseTextItem?i.text:"";return this.itemsData[e]=this.itemsData[e]||{},this.itemsData[e].text=a,this.emitChange(),a}get token(){return this._token}async getToken(){const e=await this.getEditor();let t="";try{t=await e.eval("spEditor.configuration.tokenId;")}catch(e){console.error("Failed to get user token")}return this._token=t,this.emitChange(),t}};z=i.b([Object(S.a)("au-widget-design-editor",a)],z)}}]);